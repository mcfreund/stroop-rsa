---
title: "group-level analysis: LFPC/DMFC dissociation"
author: "michael freund"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    theme: spacelab
    highlight: zenburn
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(
  fig.align = 'center', fig.width = 11.5, fig.fullwidth = TRUE,
  cache = TRUE
  )


library(here)
library(knitr)
library(magrittr)
library(data.table)
library(ggplot2)
library(mikeutils)
library(doParallel)
library(foreach)
library(gifti)
library(viridis)
library(colorspace)
library(boot)
library(vegan)
library(grid)
library(gridExtra)
library(lme4)
library(lmerTest)
library(multcomp)
library(dplyr)
library(magick)
library(viridis)
library(cowplot)
library(lemon)
source(here("code", "strings.R"))
source(here("code", "funs.R"))
source(here("code", "read_atlases.R"))


## global settings


theme_set(theme_bw(base_size = 8))
n_cores <- detectCores()
nresamps <- 1E4
figwidth <- 4.2  ## cm

axis.text.size <- rel(1)
axis.title.size <- rel(1)
axis.line.size <- rel(1)
label.size <- rel(3)
p.value.size <- rel(2)
p.line.size <- rel(0.5)
geom.line.size <- rel(1)
geom.point.size <- rel(2)


## functions

boot_mean_ci <- function(x, R = 1E4, type = "bca", ...) {
  
  out <- boot::boot(x, statistic = function(x, ii) mean(x[ii]), R = R)
  ci <- boot::boot.ci(out, type = type)[[type]][4:5]
  
  data.frame(y = out$t0, ymin = ci[1], ymax = ci[2])
  
}


## strings


colors.model <- c(incongruency = "#d95f02", target = "#1b9e77", distractor = "#7570b3")
colors.region <- setNames(viridis(3), c("DLPFC", "LPPC", "DMFC"))

params.interest <- names(colors.model)

md <- list(
  core       = c("p9-46v", "a9-46v", "i6-8", "AVI", "8C", "IFJp", "IP2", "IP1", "PFm", "8BM", "SCEF"),
  extended   = c(
    "p9-46v", "a9-46v", "i6-8", "AVi", "8C", "IFJp", "IP2", "IP1", "PFm", "8BM",
    "TE1m", "TE1p", "PGs", "PFm", "AIP", "MIP", "LIPd", "IP1", "IP2", "s6-8", 
    "i6-8", "a9-46v", "FOP5", "AVI", "11l", "a10p", "p10p", "a47r", "p47r"
  )
)


## data

## subject-level data:
stats.subjs.mmp <- 
  fread(
    here("out", "rsa", "stats", paste0("subjs_pro_bias_acc-only_mmp_pearson_residual.csv"))
    )
stats.subjs.mmp <- stats.subjs.mmp[is.analysis.group == TRUE, ]  ## EXCLUDE HELD OUT SUBJECTS!
stats.subjs.mmp %<>% full_join(atlas.key$mmp, by = "roi")

stats.subjs.super <- 
  fread(
    here("out", "rsa", "stats", paste0("subjs_pro_bias_acc-only_masks_pearson_residual.csv"))
    ) %>%
    filter(is.analysis.group, param %in% c("target", "distractor", "incongruency")) %>%
  mutate(roi.hemi = roi, roi = gsub("_L|_R", "", roi), hemi = ifelse(grepl("_L", roi.hemi), "L", "R"))

## group-level data:
stats.group.mmp <- fread(here("out", "rsa", "stats", "group_pro_bias_acc-only_mmp_pearson_residual.csv"))
stats.group.mmp <- stats.group.mmp[measure == "beta" & y == "rank" & param %in% params.interest, ]
stats.group.mmp <- stats.group.mmp[, c("measure", "y") := NULL]

## similarity matrices:
rsarray.mmp <- readRDS(
  here("out", "rsa", "obsv", "rsarray_pro_bias_acc-only_mmp_pearson_residual-rank.rds")
  )[, , unique(stats.subjs.mmp$subj), ]
rsarray.super <- readRDS(
  here("out", "rsa", "obsv", "rsarray_pro_bias_acc-only_masks_pearson_residual-rank.rds")
  )[, , unique(stats.subjs.mmp$subj), ]


## underlay for workbench

inds.left <- atlas.key$mmp$roi %>% grep("_L$", .)
inds.right <- atlas.key$mmp$roi %>% grep("_R$", .)
atlas.key$mmp$roi <- atlas.key$mmp$roi[c(inds.right, inds.left)]  ## correctly order mmp atlas

fname.pscalar.mmp <- here(
  "out", "wb", 
  "Q1-Q6_RelatedValidation210.CorticalAreas_dil_Final_Final_Areas_Group_Colors.32k_fs_LR.pscalar.nii"
  )

if (!file.exists(fname.pscalar.mmp)) cifti.parcellate(name.atlas = "glasser", dir.to.write = here("out", "wb"))

```

# preliminary validation analyses

## somatomotor/visual cortex dissociation analysis

### model

```{r}

fit.prelim <- lmer(
  beta ~ 0 + interaction(roi, param) + (1 | subj),
  stats.subjs.super %>% filter(param %in% c("distractor", "target"), roi %in% c("V1", "smmouth"))
  )
summary(fit.prelim)

contrasts.prelim <- rbind(
  diag(4),  ## means
  ## cross-parcel contrasts:
  "V1-smmouth|distractor" = c(1, -1, 0, 0),
  "smmouth-V1|target"     = c(0, 0, 1, -1),
  ## within-parcel contrasts:
  "distractor-target|V1"     = c(0, 1, 0, -1),
  "target-distractor|smmouth"= c(-1, 0, 1, 0),
  ## interaction:
  "(smmouth-V1)(target-distractor)" = c(-1, -1, 1, 1)
)
rownames(contrasts.prelim)[1:4] <- c("V1.distractor", "smmouth.distractor", "V1.target", "smmouth.target")

(glht.prelim <- summary(glht(fit.prelim, contrasts.prelim, alternative = "greater"), test = adjusted("none")))
glht.prelim$test$pvalues["(smmouth-V1)(target-distractor)"] <- 
  glht.prelim$test$pvalues["(smmouth-V1)(target-distractor)"]*2  ## interaction should be two-sided

glht.prelim

```


### plot

```{r}

means.prelim <- stats.subjs.super %>% 
  
  filter(param %in% c("distractor", "target"), roi %in% c("evis", "smmouth")) %>%
  
  group_by(roi, param) %>%
  summarize(res = list(boot_mean_ci(beta))) %>% 
  
  tidyr::unnest(cols = c(res))

p.means.prelim <- means.prelim %>%
  
  ggplot(aes(param, y, group = roi, color = roi)) +
  
  geom_point(size = geom.point.size, position = position_dodge(width = 0.25)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), position = position_dodge(width = 0.25), width = 0, size = geom.line.size) +
  geom_line(size = geom.line.size, position = position_dodge(width = 0.25)) +
  
  scale_color_manual(values = c(evis = "#b2182b", smmouth = "#2166ac")) +
  coord_capped_cart(left = "both") +
  
  annotate(
    geom = "text", x = 0.5, y = 0.12, label = "ventral S1/M1", color = "#2166ac",
    hjust = 0, vjust = 1, size = label.size*1.5, fontface = "bold"
    ) +
  annotate(
    geom = "text", x = 0.5, y = 0.09, label = "V1", color = "#b2182b",
    hjust = 0, vjust = 1, size = label.size*1.5, fontface = "bold"
    ) +
  
  annotate(
    geom = "text", x = 0.5, y = 0.08,
    label = paste0("p(distr.-targt.)>0 = ", round(glht.prelim$test$pvalues["distractor-target|V1"], 4)),
    color = "#b2182b",
    hjust = 0, vjust = 1, size = label.size, fontface = "bold"
    ) +

  annotate(
    geom = "text", x = 0.5, y = 0.11,
    label = bquote("p(targt.-distr.)>0 <"~2%*%10^-16),
    color = "#2166ac",
    hjust = 0, vjust = 1, size = label.size, fontface = "bold"
    ) +

  
  labs(y = bquote("Model fit ("*bar(beta)*")"), x = "Model") +
  
  theme(
    legend.position = "none", 
    panel.grid      = element_blank(), 
    panel.border    = element_blank(),
    axis.line.y     = element_line(size = axis.line.size),
    axis.text       = element_text(size = axis.text.size),
    # axis.text.x     = element_text(color = colors.model),
    axis.ticks.y    = element_line(size = axis.line.size),
    axis.ticks.x    = element_blank(),
    axis.title    = element_text(size = axis.title.size)
    )  ## will trip warning due to bquote weirdness

p.means.prelim

ggsave(here("out", "group", "prelim.pdf"), p.means.prelim, device = "pdf", width = figwidth, height = 3)

```

## MDS of select parcels

```{r, fig.height = 5, fig.width = 5}

## read data:

rsarray.line <- readRDS(
  here("out", "rsa", "obsv", "rsarray_pro_bias_acc-only_masks_pearson_residual-linear.rds")
  )[, , unique(stats.subjs.mmp$subj), ]

rois.mds <- c(distr = "evis", incon = "dmfc_L", targt = "smmouth")

## mds ----

set.seed(0)
mds <- lapply(rois.mds, nmds, arr = rsarray.line)

## add lines

mds.lines <- list(
  
  distr = list(
    ## distractor coding
    ## BLUE
    mds.line("blueBLUE", "purpleBLUE"),
    mds.line("purpleBLUE", "redBLUE"),
    mds.line("whiteBLUE", "blueBLUE"),
    mds.line("redBLUE", "whiteBLUE"),
    ## WHITE
    mds.line("purpleWHITE", "whiteWHITE"),
    mds.line("purpleWHITE", "blueWHITE"),
    mds.line("redWHITE", "blueWHITE"),
    mds.line("whiteWHITE", "redWHITE"), 
    ## RED
    mds.line("blueRED", "whiteRED"),
    mds.line("whiteRED", "redRED"),
    mds.line("purpleRED", "redRED"),
    mds.line("purpleRED", "blueRED"),
    ## PURPLE
    mds.line("bluePURPLE", "redPURPLE"),
    mds.line("redPURPLE", "purplePURPLE"), 
    mds.line("purplePURPLE", "whitePURPLE"),
    mds.line("whitePURPLE", "bluePURPLE")
  ),
  
  incon = list(
    ## congruency & target
    ## blue
    mds.line("blueBLUE", "blueWHITE"),
    mds.line("blueBLUE", "blueRED"),
    mds.line("blueBLUE", "bluePURPLE"),
    ## white
    mds.line("whiteWHITE", "whiteBLUE"),
    mds.line("whiteWHITE", "whiteRED"),
    mds.line("whiteWHITE", "whitePURPLE"),
    ## red
    mds.line("redRED", "redBLUE"),
    mds.line("redRED", "redWHITE"),
    mds.line("redRED", "redPURPLE"),
    ## purple
    mds.line("purplePURPLE", "purpleBLUE"),
    mds.line("purplePURPLE", "purpleWHITE"),
    mds.line("purplePURPLE", "purpleRED")
  ),
  
  targt = list(
    ## target
    ## blue
    mds.line("blueWHITE", "bluePURPLE"),
    mds.line("blueRED", "bluePURPLE"),
    mds.line("blueWHITE", "blueBLUE"),
    mds.line("blueBLUE", "blueRED"),
    ## white
    mds.line("whiteWHITE", "whitePURPLE"),
    mds.line("whitePURPLE", "whiteRED"),
    mds.line("whiteBLUE", "whiteRED"),
    mds.line("whiteBLUE", "whiteWHITE"),
    ## red
    mds.line("redRED", "redBLUE"),
    mds.line("redBLUE", "redPURPLE"),
    mds.line("redWHITE", "redPURPLE"),
    mds.line("redRED", "redWHITE"),
    ## purple
    mds.line("purplePURPLE", "purpleRED"),
    mds.line("purpleRED", "purpleBLUE"),
    mds.line("purpleBLUE", "purpleWHITE"),
    mds.line("purpleWHITE", "purplePURPLE")
  )
  
)

## get grobs

grobs <- list(
    target       = plot.mds(mds$targt, .add.lines = mds.lines$targt, .size = rel(2), .fill = "transparent"),
    distractor   = plot.mds(mds$distr, .add.lines = mds.lines$distr, .size = rel(2), .fill = "transparent"),
    incongruency = plot.mds(mds$incon, .add.lines = mds.lines$incon, .size = rel(2), .fill = "transparent")
  ) %>%
  lapply(ggplotGrob)

## create layout

radius.rel <- 1.2  ## relative size of each MDS circle (used to build positions of circle centers)
radius.abs <- unit(figwidth/4.5, "cm")  ## absolute size of circle
a <- 0.2  ## scale factor of coordinates (controls distances among MDS circles)
b <- 2  ## scale factor of MDS embedding
h <- 2.54*figwidth

coordinates <- data.frame(
  x = seq(radius.rel, radius.rel * 3, by = radius.rel),
  y = c(sqrt(3) * radius.rel * 2, sqrt(3) * radius.rel, sqrt(3) * radius.rel * 2)
)
x.center <- 0.5
y.center <- 0.575
# y.center <- mean(coordinates[1:2, 2])
coordinates <- coordinates * a
coordinates <- sweep(scale(coordinates, scale = FALSE), 2, c(x.center, y.center), "+") %>% as.data.frame
# as.data.frame(scale(coordinates, scale = FALSE) + mean(coordinates[1:2, 2]))  ## center

## order everything
mds.order <- c("target", "incongruency", "distractor")
colors.profs <- colors.model[mds.order]
grobs <- grobs[mds.order]

## draw ----

## to file:

cairo_pdf(
  here("out", "group", "mds.pdf"),
  height = h, width = h
)

grid.circle(
  coordinates$x, coordinates$y, 
  r = radius.abs, gp = gpar(lwd = 3, fill = "transparent", col = colors.profs)
  )

vps <- vector("list", length(grobs))
for (ii in seq_along(grobs)) {
  vp <- viewport(x = coordinates$x[ii], y = coordinates$y[ii], width = radius.abs * b, height = radius.abs * b)
  pushViewport(vp)
  grid.draw(grobs[[ii]])
  upViewport()
}

p.mds <- grid.grab(wrap.grobs = TRUE)

dev.off()

## for rmd:
rois.mds
grid.arrange(p.mds)

```


# MFC/DLPFC/LPPC dissociation analyses

## primary analysis

* suerparcel level
* more restrictive definitions of DLPFC and DMFC

### plot all superparcels

```{r}

## all superparcels:

stats.subjs.super %>%
  
  filter(param %in% params.interest, roi %in% c("dlpfc", "dmfc", "lppc")) %>%
  
  ggplot(aes(roi.hemi, beta, color = param)) +
  stat_summary(fun.data = mean_cl_boot, size = 2, position = position_dodge(width = 0.5)) +
  
  scale_color_manual(values = colors.model) +
  annotate(
    geom = "text", x = -Inf, y = 0.15, label = "incongruency", color = colors.model["incongruency"],
    hjust = 0, vjust = 1, size = rel(6)
    ) +
  annotate(
    geom = "text", x = -Inf, y = 0.14, label = "target", color = colors.model["target"],
    hjust = 0, vjust = 1, size = rel(6)
    ) +
  annotate(
    geom = "text", x = -Inf, y = 0.13, label = "distractor", color = colors.model["distractor"],
    hjust = 0, vjust = 1, size = rel(6)
    ) +

  theme(legend.position = "none") +
  labs(title = "superparcels")

```


### model and make fig panel


```{r fig.height = 7, fig.width = 9}

## model ----

fit.super <- lmer(
  beta ~ 0 + interaction(roi.hemi, param) + (roi * param | subj), 
  stats.subjs.super %>% filter(roi %in% c("dlpfc", "dmfc", "lppc")),
  control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1E9))
  )
summary(fit.super)

is.distractor <- grepl("distractor", names(fixef(fit.super)))
is.incongruency <- grepl("incongruency", names(fixef(fit.super)))
is.target <- grepl("target", names(fixef(fit.super)))

is.dlpfc <- grepl("dlpfc", names(fixef(fit.super)))
is.lppc <- grepl("lppc", names(fixef(fit.super)))
is.dmfc <- grepl("dmfc", names(fixef(fit.super)))

is.left <- grepl("_L", names(fixef(fit.super)))
is.right <- grepl("_R", names(fixef(fit.super)))


contrasts.super <- rbind(
  
  ## region*model means (over hemi)
  
  DLPFC_L.target = is.dlpfc * is.target * is.left,
  LPPC_L.target = is.lppc * is.target * is.left,
  DMFC_L.target = is.dmfc * is.target * is.left,
  DLPFC_R.target = is.dlpfc * is.target * is.right,
  LPPC_R.target = is.lppc * is.target * is.right,
  DMFC_R.target = is.dmfc * is.target * is.right,
  
  DLPFC_L.distractor = is.dlpfc * is.distractor * is.left,
  LPPC_L.distractor = is.lppc * is.distractor * is.left,
  DMFC_L.distractor = is.dmfc * is.distractor * is.left,
  DLPFC_R.distractor = is.dlpfc * is.distractor * is.right,
  LPPC_R.distractor = is.lppc * is.distractor * is.right,
  DMFC_R.distractor = is.dmfc * is.distractor * is.right,

  DLPFC_L.incongruency = is.dlpfc * is.incongruency * is.left,
  LPPC_L.incongruency = is.lppc * is.incongruency * is.left,
  DMFC_L.incongruency = is.dmfc * is.incongruency * is.left,
  DLPFC_R.incongruency = is.dlpfc * is.incongruency * is.right,
  LPPC_R.incongruency = is.lppc * is.incongruency * is.right,
  DMFC_R.incongruency = is.dmfc * is.incongruency * is.right,
  
  # DLPFC.target = is.dlpfc * is.target / 2,
  # LPPC.target = is.lppc * is.target / 2,
  # DMFC.target = is.dmfc * is.target / 2,
  # 
  # DLPFC.distractor = is.dlpfc * is.distractor / 2,
  # LPPC.distractor = is.lppc * is.distractor / 2,
  # DMFC.distractor = is.dmfc * is.distractor / 2,
  # 
  # DLPFC.incongruency = is.dlpfc * is.incongruency / 2,
  # LPPC.incongruency = is.lppc * is.incongruency / 2,
  # DMFC.incongruency = is.dmfc * is.incongruency / 2,
  
  ## within-region contrasts (over hemi)
  
  "target-distractor|DLPFC" = is.dlpfc * is.target - is.dlpfc * is.distractor / 2,
  "target-distractor|LPPC"  = is.lppc * is.target - is.lppc * is.distractor / 2,
  "target-distractor|DMFC"  = is.dmfc * is.target - is.dmfc * is.distractor / 2,
  
  "target-incongruency|DLPFC" = is.dlpfc * is.target - is.dlpfc * is.incongruency / 2,
  "target-incongruency|LPPC"  = is.lppc * is.target - is.lppc * is.incongruency / 2,
  "target-incongruency|DMFC"  = is.dmfc * is.target - is.dmfc * is.incongruency / 2,
  
  ## within-region target-incongruency contrsts (by hemi)

  "target-incongruency|DLPFC_L" = (is.dlpfc * is.target - is.dlpfc * is.incongruency) * is.left,
  "target-incongruency|LPPC_L" = (is.lppc * is.target - is.lppc * is.incongruency) * is.left,
  "target-incongruency|DMFC_L" = (is.dmfc * is.target - is.dmfc * is.incongruency) * is.left,
  
  "target-incongruency|DLPFC_R" = (is.dlpfc * is.target - is.dlpfc * is.incongruency) * is.right,
  "target-incongruency|LPPC_R" = (is.lppc * is.target - is.lppc * is.incongruency) * is.right,
  "target-incongruency|DMFC_R" = (is.dmfc * is.target - is.dmfc * is.incongruency) * is.right

)

glht.super <- summary(glht(fit.super, contrasts.super), test = adjusted("none"))

p.fdr.tvi.dlpfc.super <- glht.super$test$pvalues[grep("\\|DLPFC_", rownames(contrasts.super))] %>% p.adjust(method = "fdr")
p.fdr.tvi.lppc.super <- glht.super$test$pvalues[grep("\\|LPPC_", rownames(contrasts.super))] %>% p.adjust(method = "fdr")
p.fdr.tvi.dmfc.super <- glht.super$test$pvalues[grep("\\|DMFC_", rownames(contrasts.super))] %>% p.adjust(method = "fdr")

contrasts.super.all <- rbind(
  contrasts.super,
  ## cross-region contrasts:
  "DLPFC-DMFC_L|incongruency" = (is.dlpfc/2 - (is.dmfc * is.left)) * is.incongruency,
  "DLPFC-LPPC_L|incongruency" = (is.dlpfc/2 - (is.lppc * is.left)) * is.incongruency,
  "DLPFC-DMFC_L|target" = (is.dlpfc/2 - (is.dmfc * is.left)) * is.target,
  "DLPFC-LPPC_L|target" = (is.dlpfc/2 - (is.lppc * is.left)) * is.target,
  
  ## interactions:
  "(DLPFC-DMFC_L)(target-incongruency)" = 
    (is.dlpfc/2 - (is.dmfc * is.left)) * is.target - (is.dlpfc/2 - (is.dmfc * is.left)) * is.incongruency,
  "(DLPFC-LPPC_L)(target-incongruency)" = 
    (is.dlpfc/2 - (is.lppc * is.left)) * is.target - (is.dlpfc/2 - (is.lppc * is.left)) * is.incongruency
  
)

(glht.super.all <- summary(glht(fit.super, contrasts.super.all), test = adjusted("none")))


## table ----

table.group.type <- c(
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "conditional mean",
  "within-region contrast",
  "within-region contrast",
  "within-region contrast",
  "within-region contrast",
  "within-region contrast",
  "within-region contrast",
  "within-region contrast",
  "within-region contrast",
  "within-region contrast",
  "within-region contrast",
  "within-region contrast",
  "within-region contrast",
  "between-region contrast",
  "between-region contrast",
  "between-region contrast",
  "between-region contrast",
  "interaction",
  "interaction"
)


table.group.contrast <- c(
  "\\textit{target DLPFC (L)}",
  "\\textit{target LPPC (L)}",
  "\\textit{target DMFC (L)}",
  "\\textit{target DLPFC (R)}",
  "\\textit{target LPPC (R)}",
  "\\textit{target DMFC (R)}",
  "\\textit{distractor DLPFC (L)}",
  "\\textit{distractor LPPC (L)}",
  "\\textit{distractor DMFC (L)}",
  "\\textit{distractor DLPFC (R)}",
  "\\textit{distractor LPPC (R)}",
  "\\textit{distractor DMFC (R)}",
  "\\textit{incongruency DLPFC (L)}",
  "\\textit{incongruency LPPC (L)}",
  "\\textit{incongruency DMFC (L)}",
  "\\textit{incongruency DLPFC (R)}",
  "\\textit{incongruency LPPC (R)}",
  "\\textit{incongruency DMFC (R)}",
  "\\textit{DLPFC: }$\\mathit{target}-\\mathit{distractor}$",
  "\\textit{LPPC: }$\\mathit{target}-\\mathit{distractor}$",
  "\\textit{DMFC: }$\\mathit{target}-\\mathit{distractor}$",
  "\\textit{DLPFC: }$\\mathit{target}-\\mathit{incongruency}$",
  "\\textit{LPPC: }$\\mathit{target}-\\mathit{incongruency}$",
  "\\textit{DMFC: }$\\mathit{target}-\\mathit{incongruency}$",
  "\\textit{DLPFC (L): }$\\mathit{target}-\\mathit{incongruency}$",
  "\\textit{LPPC (L): }$\\mathit{target}-\\mathit{incongruency}$",
  "\\textit{DMFC (L): }$\\mathit{target}-\\mathit{incongruency}$",
  "\\textit{DLPFC (R): }$\\mathit{target}-\\mathit{incongruency}$",
  "\\textit{LPPC (R): }$\\mathit{target}-\\mathit{incongruency}$",
  "\\textit{DMFC (R): }$\\mathit{target}-\\mathit{incongruency}$",
  "\\textit{incongruency: }$\\mathit{DLPFC}-\\mathit{DMFC (L)}$",
  "\\textit{incongruency: }$\\mathit{DLPFC}-\\mathit{LPPC (L)}$",
  "\\textit{target: }$\\mathit{DLPFC}-\\mathit{DMFC (L)}$",
  "\\textit{target: }$\\mathit{DLPFC}-\\mathit{LPPC (L)}$",
  "$(\\mathit{DLPFC}-\\mathit{DMFC (L)})\\times(\\mathit{target}-\\mathit{incongruency})$",
  "$(\\mathit{DLPFC}-\\mathit{LPPC (L)})\\times(\\mathit{target}-\\mathit{incongruency})$"
)


table.group <- data.frame(
  contrast = table.group.contrast,
  type = table.group.type,
  b = glht.super.all$test$coefficients,
  se = glht.super.all$test$sigma,
  t = glht.super.all$test$tstat,
  p = glht.super.all$test$pvalues
)
table.group$p.raw <- table.group$p
table.group[
  table.group$contrast %in% c(names(p.fdr.tvi.dlpfc.super), names(p.fdr.tvi.lppc.super), names(p.fdr.tvi.dmfc.super)),
  "p"
] <- c(p.fdr.tvi.dlpfc.super, p.fdr.tvi.lppc.super, p.fdr.tvi.dmfc.super)
rownames(table.group) <- NULL
# names(table.group)[3] <- "$\\bar\\beta$"
# names(table.group)[4] <- "$\\sigma$"

kable(table.group)

fwrite(table.group, here("out", "group", "superparcels.txt"))


## figure ----

set.seed(0)
means.super <- stats.subjs.super %>%
  
  mutate(roi.hemi = paste0(roi, "_", hemi)) %>%
  filter(roi.hemi %in% c("dlpfc_L", "dlpfc_R", "dmfc_L", "lppc_L")) %>%
  
  group_by(roi, param, subj) %>%
  summarize(beta = mean(beta)) %>% 
  
  group_by(roi, param) %>%
  summarize(res = list(boot_mean_ci(beta))) %>% 
  
  tidyr::unnest(cols = c(res))


p.means.super <- means.super %>%  
  
  mutate(param = factor(as.factor(param), levels = c("incongruency", "target", "distractor"))) %>%
  
  ggplot(aes(param, y, group = roi, color = roi)) +
  geom_point(size = geom.point.size, position = position_dodge(width = 1/2)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), position = position_dodge(width = 1/2), width = 0, size = geom.line.size) +
  geom_line(size = geom.line.size, position = position_dodge(width = 1/2)) +

  scale_color_manual(values = colors.region %>% setNames(tolower(names(.)))) +
  lemon::coord_capped_cart(left = "both") +
  # scale_y_continuous(breaks = c(0, 0.18), limits = c(-0.0205, 0.18)) +
  scale_x_discrete(labels = c("incon.", "targ.", "distr.")) +
  
  annotate(
    geom = "text", x = Inf, y = 0.1, label = "DLPFC (bil.)", color = colors.region["DLPFC"],
    hjust = 1, vjust = 1, size = label.size, fontface = "bold"
    ) +
  annotate(
    geom = "text", x = Inf, y = 0.12, label = "LPPC (L)", color = colors.region["LPPC"],
    hjust = 1, vjust = 1, size = label.size, fontface = "bold"
    ) +
  annotate(
    geom = "text", x = Inf, y = 0.14, label = "DMFC (L)", color = colors.region["DMFC"],
    hjust = 1, vjust = 1, size = label.size, fontface = "bold"
    ) +
  
  labs(y = bquote("Model fit ("*bar(beta)*")"), x = "Model") +
  
  theme(
    legend.position = "none", 
    panel.grid      = element_blank(), 
    panel.border    = element_blank(),
    axis.line.y     = element_line(size = axis.line.size),
    axis.text       = element_text(size = axis.text.size),
    # axis.text.x     = element_text(color = colors.model),
    axis.ticks.y    = element_line(size = axis.line.size),
    axis.ticks.x    = element_blank(),
    axis.title    = element_text(size = axis.title.size)
    )

ggsave(here("out", "group", "crossplot_superparcels.pdf"), p.means.super, device = "pdf", width = 4, height = 3)

```


### arrange figure

```{r}

plot.group <- plot_grid(
  p.mds,
  p.means.super,
  ncol = 2,
  vjust = c(1.25, 1.25),
  labels = "AUTO",
  label_size = 12
)

plot.group

ggsave(
  here("out", "group", "fig_group.pdf"), 
  plot.group, 
  device = "pdf", height = 4.25, width = 8.5, unit = "cm"
  )

```


### noise ceilings

Some evidence for single dissociation was found.
Stronger incongruency coding versus target coding in LPPC parcels.
Additionally, evidence for stronger incongruency coding in MFC versus DLPFC.
(But not incon>target within MFC).
This pattern leaves open the possibility that SNR was poor in DLPFC.
This possibility is tested here by computing and comparing noise ceilings across these parcels.

```{r, fig.height = 7, fig.width = 9}


## estimate noise ceilings ----

ceilings.super <- lapply(dimnames(rsarray.super)$roi, noise.ceiling, x = rsarray.super)
names(ceilings.super) <- dimnames(rsarray.super)$roi
ceilings.super %<>% bind_rows(.id = "roi")
ceilings.super <- ceilings.super %>% 
  
  mutate(
    region = toupper(gsub("_L|_R", "", roi)), 
    hemi = ifelse(grepl("_L", roi), "L", "R"),
    region.hemi = paste0(region, "_", hemi)
    )

## quick plot of all parcels ----


ceilings.super %>%
  
  filter(region %in% c("DLPFC", "DMFC", "LPPC")) %>%
  
  {
    grid.arrange(
      
      
      ggplot(., aes(roi, lb, color = region)) +
        stat_summary(fun.data = mean_cl_boot, size = 2) +
        scale_color_viridis_d() +
        theme(legend.position = "none") +
        labs(title = "lower bound", x = "parcel", y = "across-subject mean"),
      
      
      ggplot(., aes(roi, ub, color = region)) +
        stat_summary(fun.data = mean_cl_boot, size = 2) +
        scale_color_viridis_d() +
        annotate(
          geom = "text", x = -Inf, y = 0.25, label = "DLPFC", color = colors.region["DLPFC"],
          hjust = 0, vjust = 1, size = rel(6)
          ) +
        annotate(
          geom = "text", x = -Inf, y = 0.24, label = "LPPC", color = colors.region["LPPC"],
          hjust = 0, vjust = 1, size = rel(6)
          ) +
        annotate(
          geom = "text", x = -Inf, y = 0.23, label = "MFC", color = colors.region["MFC"],
          hjust = 0, vjust = 1, size = rel(6)
          ) +
        theme(legend.position = "none") +
        labs(title = "upper bound", x = "parcel", y = "across-subject mean"),
      
      ncol = 2,
      
      top = textGrob("noise ceilings", gp = gpar(fontsize = 24))
      
    )
  }


## estimate ceilings by region (parcel as fixed effect) ----

ceilings.super.rois <- ceilings.super %>% 
  filter(region.hemi %in% c("DLPFC_L", "DLPFC_R", "LPPC_L", "DMFC_L")) %>%
  group_by(subj, region) %>%
  summarize_if(is.numeric, mean)  ## average across hemisphere


means.ceilings.super.rois <- ceilings.super.rois %>%
  
  group_by(region) %>%
  
  { 
    bind_rows(
      
      summarize(., res = list(boot_mean_ci(lb))) %>% 
        tidyr::unnest(cols = c(res)) %>%
        mutate(ceiling = "lower"),
      
      summarize(., res = list(boot_mean_ci(ub))) %>% 
        tidyr::unnest(cols = c(res)) %>%
        mutate(ceiling = "upper")
      
    )
  }

## get contrasts among regions:
means.ceilings.contr.super.rois <- ceilings.super.rois %>%
  
  mutate(ub = atanh(ub), lb = atanh(lb)) %>%
  
  group_by(region) %>%

  { 
    bind_rows(
      
      
      tidyr::pivot_wider(., -ub, names_from = "region", values_from = "lb") %>%
        
      transmute(
        DLPFC.DMFC  = DLPFC - DMFC,
        LPPC.DMFC   = LPPC - DMFC,
        DLPFC.LPPC = LPPC - DLPFC
      ) %>%
      summarize(
        DLPFC.DMFC  = list(boot_mean_ci(DLPFC.DMFC)),
        LPPC.DMFC   = list(boot_mean_ci(LPPC.DMFC)),
        DLPFC.LPPC = list(boot_mean_ci(DLPFC.LPPC)),
        ) %>% 
      tidyr::unnest(cols = c(DLPFC.DMFC, LPPC.DMFC, DLPFC.LPPC), names_sep = ".") %>%
      mutate(ceiling = "lower"),
      
      
      tidyr::pivot_wider(., -lb, names_from = "region", values_from = "ub") %>%
        
      transmute(
        DLPFC.DMFC  = DLPFC - DMFC,
        LPPC.DMFC   = LPPC - DMFC,
        DLPFC.LPPC = LPPC - DLPFC
      ) %>%
      summarize(
        DLPFC.DMFC  = list(boot_mean_ci(DLPFC.DMFC)),
        LPPC.DMFC   = list(boot_mean_ci(LPPC.DMFC)),
        DLPFC.LPPC = list(boot_mean_ci(DLPFC.LPPC)),
        ) %>% 
      tidyr::unnest(cols = c(DLPFC.DMFC, LPPC.DMFC, DLPFC.LPPC), names_sep = ".") %>%
      mutate(ceiling = "upper")
      
    )
    
  }
## get p-values for contrasts....
res.ceilings.contr.super.rois <- 
  
  boot(
    
    data = 
      
      ceilings.super.rois %>%
      mutate(ub = atanh(ub), lb = atanh(lb)) %>%
      group_by(region) %>%
      tidyr::pivot_wider(names_from = "region", values_from = c("lb", "ub")) %>%
      transmute(
        
        DLPFC.DMFC_lb  = lb_DLPFC - lb_DMFC,
        LPPC.DMFC_lb   = lb_LPPC - lb_DMFC,
        DLPFC.LPPC_lb = lb_LPPC - lb_DLPFC,
        
        DLPFC.DMFC_ub  = ub_DLPFC - ub_DMFC,
        LPPC.DMFC_ub   = ub_LPPC - ub_DMFC,
        DLPFC.LPPC_ub = ub_LPPC - ub_DLPFC
        ),
    
    statistic = function(x, ii) colMeans(x[ii, ]), 
    
    R = 1E4
    
)
p.ceilings.contr.super.rois <- 
  lapply(1:6, ci2p, bootobj = res.ceilings.contr.super.rois) %>% 
  do.call(rbind, .) %>% 
  as.data.frame %>% setNames("p")
p.ceilings.contr.super.rois$contrast <- c("dlpfc.dmfc", "lppc.dmfc", "dlpfc.lppc", "dlpfc.dmfc", "lppc.dmfc", "dlpfc.lppc")
p.ceilings.contr.super.rois$ceiling <- rep(c("lb", "ub"), each = 3)


## plot ----

p.means.ceilings.super <- means.ceilings.super.rois %>%
  
  filter(ceiling == "upper") %>%
  
  ggplot(aes(region, y)) +
  
  geom_line(
    data = ceilings.super.rois,
    aes(x = region, y = ub, group = subj),
    alpha = 0.1, size = 1,
    inherit.aes = FALSE
  ) +
  
  geom_point(size = 8) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0, size = 3) +

  # scale_color_manual(values = colors.region) +
  
  annotate(
    geom = "text", x = 1.5, y = 0.4, size = rel(8), vjust = 0, color = "grey40", fontface = "italic",
    label = paste0(
      "p = ", 
      p.ceilings.contr.super.rois %>% filter(contrast == "dlpfc.dmfc", ceiling == "ub") %>% pull("p") %>% round(2)
      )
    ) +
  annotate(geom = "segment", x = 1, xend = 3, y = 0.395, yend = 0.395, color = "grey40", size = 1) +
  
  annotate(
    geom = "text", x = 2.5, y = 0.35, size = rel(8), vjust = 0, color = "grey40", fontface = "italic",
    label = paste0(
      "p = ", 
      p.ceilings.contr.super.rois %>% filter(contrast == "lppc.dmfc", ceiling == "ub") %>% pull("p") %>% round(2)
      )
    ) +
  annotate(geom = "segment", x = 2, xend = 3, y = 0.345, yend = 0.345, color = "grey40", size = 1) +
  
  annotate(
    geom = "text", x = 1.5, y = 0.3, size = rel(8), vjust = 0, color = "grey40", fontface = "italic",
    label = paste0(
      "p = ", 
      p.ceilings.contr.super.rois %>% filter(contrast == "dlpfc.lppc", ceiling == "ub") %>% pull("p") %>% round(2)
      )
    ) +
  annotate(geom = "segment", x = 1, xend = 2, y = 0.295, yend = 0.295, color = "grey40", size = 1) +

  labs(y = bquote("mean noise ceiling"), x = "region") +

  theme(
    legend.position = "none",
    panel.grid      = element_blank(),
    panel.border    = element_blank(),
    axis.line.y     = element_line(size = rel(2)),
    axis.text       = element_text(size = rel(3)),
    axis.ticks.y    = element_line(size = rel(2)),
    axis.ticks.x    = element_blank(),
    axis.title    = element_text(size = rel(4))
    )  ## will trip warning due to vectorized input to axis.text.x (for colors)

p.means.ceilings.super


fwrite(p.ceilings.contr.super.rois, here("out", "group", "ceilings.txt"))


```



## alternative analyses

* alt analysis 1: parcel-level
* alt analysis 2: less restrictive definitions of DLPFC and DMFC

### parcel-level

```{r}

## format ----

rois.lppc <- combo_paste(
  c("IP0", "IPS1", "IP1", "MIP", "7PL", "7AL", "7PC", "VIP", "LIPv", "LIPd", "AIP", "IP2"), 
  c("L", "R")
  )
rois.dmfc <- combo_paste(c("SCEF", "8BM",  "p32pr", "a32pr"), c("L", "R"))
rois.dlpfc <- combo_paste(c("p9-46v", "i6-8", "8Av", "8C"), c("L", "R"))

d.mmp <- stats.subjs.mmp %>% 
  
  filter(roi %in% c(rois.dmfc, rois.dlpfc, rois.lppc)) %>%
  
  mutate(
    region = ifelse(
      roi %in% rois.dlpfc, "DLPFC", 
      ifelse(
        roi %in% rois.dmfc, "DMFC",
        ifelse(roi %in% rois.lppc, "LPPC", NA)
        )
      ),
    region.hemi = paste0(region, "_", hemi)
    )


## plot ----


set.seed(0)
means.mmp <- d.mmp %>%
  
  filter(param %in% c("incongruency", "target", "distractor")) %>%
  group_by(roi, param, subj) %>%
  summarize(beta = mean(beta)) %>% 
  
  group_by(roi, param) %>%
  summarize(res = list(boot_mean_ci(beta))) %>% 
  
  tidyr::unnest(cols = c(res))


p.mmp.lppc <- means.mmp %>%
  
  filter(param %in% c("incongruency", "target", "distractor"), roi %in% rois.lppc) %>%
  
  ggplot(aes(roi, y, color = param)) +
  geom_hline(yintercept = 0, color = "grey40") +
  geom_point(size = geom.point.size, position = position_dodge(width = 1/2)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), position = position_dodge(width = 1/2), width = 0, size = geom.line.size) +
  lemon::coord_capped_cart(left = "both") +
  scale_y_continuous(limits = c(-0.05, 0.225)) +
  scale_color_manual(values = colors.model) +
  labs(y = bquote("Model fit ("*bar(beta)*")")) +
  theme(
    legend.position = "none", 
    panel.grid      = element_blank(), 
    panel.border    = element_blank(),
    axis.line.y     = element_line(size = axis.line.size),
    axis.text       = element_text(size = axis.text.size*3/4),
    # axis.text.x     = element_text(color = colors.model),
    axis.ticks.y    = element_line(size = axis.line.size),
    axis.ticks.x    = element_blank(),
    axis.title      = element_text(size = axis.title.size),
    axis.title.x    = element_blank()
    )

p.mmp.dlpfc <- means.mmp %>%
  
  filter(param %in% c("incongruency", "target", "distractor"), roi %in% rois.dlpfc) %>%
  
  ggplot(aes(roi, y, color = param)) +
  geom_hline(yintercept = 0, color = "grey40") +
  geom_point(size = geom.point.size, position = position_dodge(width = 1/2)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), position = position_dodge(width = 1/2), width = 0, size = geom.line.size) +
  lemon::coord_capped_cart(left = "both") +
  scale_y_continuous(limits = c(-0.05, 0.225)) +
  scale_color_manual(values = colors.model) +
  labs(y = bquote("Model fit ("*bar(beta)*")")) +
  theme(
    legend.position = "none", 
    panel.grid      = element_blank(), 
    panel.border    = element_blank(),
    axis.line.y     = element_line(size = axis.line.size),
    axis.text       = element_text(size = axis.text.size*3/4),
    # axis.text.x     = element_text(color = colors.model),
    axis.ticks.y    = element_line(size = axis.line.size),
    axis.ticks.x    = element_blank(),
    axis.title    = element_text(size = axis.title.size),
    axis.title.x    = element_blank()
    )

p.mmp.dmfc <- means.mmp %>%
  
  filter(param %in% c("incongruency", "target", "distractor"), roi %in% rois.dmfc) %>%
  
  ggplot(aes(roi, y, color = param)) +
  geom_hline(yintercept = 0, color = "grey40") +
  geom_point(size = geom.point.size, position = position_dodge(width = 1/2)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), position = position_dodge(width = 1/2), width = 0, size = geom.line.size) +
  lemon::coord_capped_cart(left = "both") +
  scale_y_continuous(limits = c(-0.05, 0.225)) +
  scale_color_manual(values = colors.model) +
  labs(y = bquote("Model fit ("*bar(beta)*")")) +
  theme(
    legend.position = "none", 
    panel.grid      = element_blank(), 
    panel.border    = element_blank(),
    axis.line.y     = element_line(size = axis.line.size),
    axis.text       = element_text(size = axis.text.size*3/4),
    # axis.text.x     = element_text(color = colors.model),
    axis.ticks.y    = element_line(size = axis.line.size),
    axis.ticks.x    = element_blank(),
    axis.title    = element_text(size = axis.title.size),
    axis.title.x    = element_blank()
    )

p.parcel <- plot_grid(
  plot_grid(p.mmp.dlpfc, p.mmp.dmfc, labels = c("A", "B"), label_size = 12), 
  p.mmp.lppc, 
  nrow = 2, labels = c("", "C"), label_size = 12
)

ggsave(here("out", "group", "alt_parcels.pdf"), p.parcel, device = "pdf", width = 20, height = 10, unit = "cm")


## model ----
# 
# d.mmp.rois <- d.mmp %>% 
#   filter(region %in% c("DLPFC", "MFC", "LPPC"), param %in% c("distractor", "incongruency", "target"))
# 
# fit.mmp <- lmer(
#   beta ~ 0 + interaction(roi, param) + (region * param | subj), 
#   d.mmp.rois,
#   control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1E9))
#   # REML = FALSE
#   )
# summary(fit.mmp)
# 
# is.distractor <- grepl("distractor", names(fixef(fit.mmp)))
# is.incongruency <- grepl("incongruency", names(fixef(fit.mmp)))
# is.target <- grepl("target", names(fixef(fit.mmp)))
# 
# is.dlpfc <- grepl(paste0(rois.dlpfc, collapse = "|"), names(fixef(fit.mmp)))
# is.lppc <- grepl(paste0(rois.lppc, collapse = "|"), names(fixef(fit.mmp)))
# is.dmfc <- grepl(paste0(rois.dmfc, collapse = "|"), names(fixef(fit.mmp)))
# 
# is.left <- grepl("_L", names(fixef(fit.mmp)))
# is.right <- grepl("_R", names(fixef(fit.mmp)))
# 
# 
# contrasts.mmp <- rbind(
#   
#   ## region*model means (over hemi)
#   
#   dlpfc.target = is.dlpfc * is.target / 2,
#   lppc.target  = is.lppc * is.target / 2,
#   dmfc.target  = is.dmfc * is.target / 2,
#   
#   dlpfc.distractor = is.dlpfc * is.distractor / 2,
#   lppc.distractor  = is.lppc * is.distractor / 2,
#   dmfc.distractor  = is.dmfc * is.distractor / 2,
#   
#   dlpfc.incongruency = is.dlpfc * is.incongruency / 2,
#   lppc.incongruency  = is.lppc * is.incongruency / 2,
#   dmfc.incongruency  = is.dmfc * is.incongruency / 2,
#   
#   ## within-region contrasts (over hemi)
#   
#   "target-distractor|dlpfc" = is.dlpfc * is.target - is.dlpfc * is.distractor / 2,
#   "target-distractor|lppc"  = is.lppc * is.target - is.lppc * is.distractor / 2,
#   "target-distractor|dmfc"  = is.dmfc * is.target - is.dmfc * is.distractor / 2,
#   
#   "target-incongruency|dlpfc" = is.dlpfc * is.target - is.dlpfc * is.incongruency / 2,
#   "target-incongruency|lppc"  = is.lppc * is.target - is.lppc * is.incongruency / 2,
#   "target-incongruency|dmfc"  = is.dmfc * is.target - is.dmfc * is.incongruency / 2,
#   
#   ## within-region target-incongruency contrsts (by hemi)
# 
#   "target-incongruency|dlpfc_L" = (is.dlpfc * is.target - is.dlpfc * is.incongruency) * is.left,
#   "target-incongruency|lppc_L" = (is.lppc * is.target - is.lppc * is.incongruency) * is.left,
#   "target-incongruency|dmfc_L" = (is.dmfc * is.target - is.dmfc * is.incongruency) * is.left,
#   
#   "target-incongruency|dlpfc_R" = (is.dlpfc * is.target - is.dlpfc * is.incongruency) * is.right,
#   "target-incongruency|lppc_R" = (is.lppc * is.target - is.lppc * is.incongruency) * is.right,
#   "target-incongruency|dmfc_R" = (is.dmfc * is.target - is.dmfc * is.incongruency) * is.right,
#   
#   ## cross-region contrasts:
#   "dlpfc-mfc_L|incongruency" = (is.dlpfc/2 - (is.dmfc * is.left)) * is.incongruency,
#   "dlpfc-lppc_L|incongruency" = (is.dlpfc/2 - (is.lppc * is.left)) * is.incongruency,
#   "dlpfc-mfc_L|target" = (is.dlpfc/2 - (is.dmfc * is.left)) * is.target,
#   "dlpfc-lppc_L|target" = (is.dlpfc/2 - (is.lppc * is.left)) * is.target,
#   
#   ## interactions:
#   "(dlpfc-mfc_L)(target-incon)" = 
#     (is.dlpfc/2 - (is.dmfc * is.left)) * is.target - (is.dlpfc/2 - (is.dmfc * is.left)) * is.incongruency,
#   "(dlpfc-lppc_L)(target-incon)" = 
#     (is.dlpfc/2 - (is.lppc * is.left)) * is.target - (is.dlpfc/2 - (is.lppc * is.left)) * is.incongruency
# 
# )
# 
# (glht.mmp <- summary(glht(fit.mmp, contrasts.mmp), test = adjusted("none")))


```


### alternate superparcel definitions

```{r fig.height = 7, fig.width = 9}

## model ----

fit.super.alt <- update(
  fit.super,
  . ~ . -  (roi * param | subj) + (roi + param | subj), 
  data = stats.subjs.super %>% filter(roi %in% c("dlpfc.alt", "dmfc.alt", "lppc"))
  )
summary(fit.super.alt)

glht.super.all.alt <- summary(glht(fit.super.alt, contrasts.super.all), test = adjusted("none"))

p.fdr.tvi.dlpfc.super.alt <- glht.super.all.alt$test$pvalues[grep("dlpfc_", rownames(contrasts.super))] %>% 
  p.adjust(method = "fdr")
p.fdr.tvi.lppc.super.alt <- glht.super.all.alt$test$pvalues[grep("lppc_", rownames(contrasts.super))] %>% 
  p.adjust(method = "fdr")
p.fdr.tvi.dmfc.super.alt <- glht.super.all.alt$test$pvalues[grep("dmfc_", rownames(contrasts.super))] %>% 
  p.adjust(method = "fdr")

## table ----

table.group.alt <- data.frame(
  contrast = table.group.contrast,
  type = table.group.type,
  b        = glht.super.all.alt$test$coefficients,
  se       = glht.super.all.alt$test$sigma,
  t        = glht.super.all.alt$test$tstat,
  p        = glht.super.all.alt$test$pvalues
)
table.group.alt$p.raw <- table.group.alt$p
table.group.alt[
  table.group.alt$contrast %in% 
    c(names(p.fdr.tvi.dlpfc.super.alt), names(p.fdr.tvi.lppc.super.alt), names(p.fdr.tvi.dmfc.super.alt)),
  "p"
] <- c(p.fdr.tvi.dlpfc.super.alt, p.fdr.tvi.lppc.super.alt, p.fdr.tvi.dmfc.super.alt)
rownames(table.group.alt) <- NULL
# names(table.group.alt)[3] <- "$\\bar\\beta$"
# names(table.group.alt)[4] <- "$\\sigma$"

kable(table.group.alt)

fwrite(table.group.alt, here("out", "group", "superparcels_alt.txt"))


## figure ----

set.seed(0)
means.super.alt <- stats.subjs.super %>%
  
  mutate(roi.hemi = paste0(roi, "_", hemi)) %>%
  filter(roi.hemi %in% c("dlpfc.alt_L", "dlpfc.alt_R", "dmfc.alt_L", "lppc_L")) %>%
  
  group_by(roi, param, subj) %>%
  summarize(beta = mean(beta)) %>% 
  
  group_by(roi, param) %>%
  summarize(res = list(boot_mean_ci(beta))) %>% 
  
  tidyr::unnest(cols = c(res))

p.means.super.alt <- means.super.alt %>%  
  
  ungroup %>%
  mutate(
    roi = gsub(".alt", "", roi),
    param = factor(as.factor(param), levels = c("incongruency", "target", "distractor"))
    ) %>%
  
  ggplot(aes(param, y, group = roi, color = roi)) +
  geom_point(size = geom.point.size, position = position_dodge(width = 1/2)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), position = position_dodge(width = 1/2), width = 0, size = geom.line.size) +
  geom_line(size = geom.line.size*3/4, position = position_dodge(width = 1/2)) +

  scale_color_manual(values = colors.region %>% setNames(tolower(names(.)))) +
  lemon::coord_capped_cart(left = "both") +
  # scale_y_continuous(breaks = c(0, 0.18), limits = c(-0.0205, 0.18)) +
  scale_x_discrete(labels = c("incon.", "targ.", "distr.")) +
  
  annotate(
    geom = "text", x = Inf, y = 0.1, label = "DLPFC (bil.)", color = colors.region["DLPFC"],
    hjust = 1, vjust = 1, size = label.size, fontface = "bold"
    ) +
  annotate(
    geom = "text", x = Inf, y = 0.12, label = "LPPC (L)", color = colors.region["LPPC"],
    hjust = 1, vjust = 1, size = label.size, fontface = "bold"
    ) +
  annotate(
    geom = "text", x = Inf, y = 0.14, label = "DMFC (L)", color = colors.region["DMFC"],
    hjust = 1, vjust = 1, size = label.size, fontface = "bold"
    ) +
  
  labs(y = bquote("Model fit ("*bar(beta)*")"), x = "Model") +
  
  theme(
    legend.position = "none", 
    panel.grid      = element_blank(), 
    panel.border    = element_blank(),
    axis.line.y     = element_line(size = axis.line.size),
    axis.text       = element_text(size = axis.text.size),
    # axis.text.x     = element_text(color = colors.model),
    axis.ticks.y    = element_line(size = axis.line.size),
    axis.ticks.x    = element_blank(),
    axis.title    = element_text(size = axis.title.size)
    )

p.means.super.alt

ggsave(here("out", "group", "crossplot_superparcels_alt.pdf"), p.means.super.alt, device = "pdf", width = 4, height = 3)


```


